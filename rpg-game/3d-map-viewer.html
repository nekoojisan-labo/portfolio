<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å®¿3Dãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ - ãƒ‡ã‚¦ã‚¹ãƒ»ã‚³ãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #0a0a1e;
            color: #ffffff;
            overflow: hidden;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        #info-panel h1 {
            color: #00ffff;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        #info-panel p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 15px 30px;
            text-align: center;
        }

        #controls h2 {
            color: #00ffff;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #controls kbd {
            background: #1e2a4a;
            border: 1px solid #00ffff;
            border-radius: 3px;
            padding: 3px 8px;
            font-family: monospace;
            color: #00ffff;
            margin: 0 3px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading h2 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .spinner {
            border: 4px solid rgba(0, 255, 255, 0.1);
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h2>ğŸ™ï¸ æ–°å®¿ãƒãƒƒãƒ—ç”Ÿæˆä¸­...</h2>
        <div class="spinner"></div>
    </div>

    <div id="canvas-container"></div>

    <div id="info-panel" style="display:none;">
        <h1>ğŸ™ï¸ æ–°å®¿ä¸­å¤®åŒºç”»</h1>
        <p>ğŸ“ <strong>ã‚¨ãƒªã‚¢:</strong> æ–°å®¿ - éƒ½å¸‚ã‚¨ãƒªã‚¢</p>
        <p>ğŸ¢ <strong>ãƒ“ãƒ«æ•°:</strong> <span id="building-count">5</span>æ£Ÿ</p>
        <p>ğŸ’¡ <strong>è¡—ç¯:</strong> <span id="light-count">9</span>æœ¬</p>
        <p>ğŸ‘¥ <strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</strong> <span id="char-count">5</span>ä½“</p>
        <p>ğŸŒ† <strong>æ™‚åˆ»:</strong> å¤•æš®ã‚Œ</p>
        <p>âš™ï¸ <strong>FPS:</strong> <span id="fps">60</span></p>
    </div>

    <div id="controls" style="display:none;">
        <h2>ğŸ® æ“ä½œæ–¹æ³•</h2>
        <p>
            <kbd>ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°</kbd> è¦–ç‚¹å›è»¢ |
            <kbd>ãƒ›ã‚¤ãƒ¼ãƒ«</kbd> ã‚ºãƒ¼ãƒ  |
            <kbd>å³ã‚¯ãƒªãƒƒã‚¯ãƒ‰ãƒ©ãƒƒã‚°</kbd> ç§»å‹•
        </p>
    </div>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>

    <!-- æ–°å®¿3Dãƒãƒƒãƒ— -->
    <script src="shinjuku-3d-map.js"></script>

    <script>
        // ==========================================
        // Three.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        // ==========================================
        let scene, camera, renderer, controls;
        let shinjukuMap;
        let clock = new THREE.Clock();
        let fpsCounter = 0;
        let fpsUpdateTime = 0;

        function init() {
            console.log('[3D Viewer] Initializing...');

            // ã‚·ãƒ¼ãƒ³
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1e);

            // ã‚«ãƒ¡ãƒ©
            camera = new THREE.PerspectiveCamera(
                60,  // FOV
                window.innerWidth / window.innerHeight,  // Aspect
                0.1,  // Near
                500   // Far
            );
            camera.position.set(50, 40, 80);
            camera.lookAt(50, 0, 40);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆOrbitControlsï¼‰
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 10;
            controls.maxDistance = 150;
            controls.maxPolarAngle = Math.PI / 2 - 0.1;  // åœ°é¢ã‚ˆã‚Šä¸‹ã«è¡Œã‹ãªã„
            controls.target.set(50, 0, 40);

            // æ–°å®¿ãƒãƒƒãƒ—ç”Ÿæˆ
            shinjukuMap = new Shinjuku3DMap(scene, camera);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('info-panel').style.display = 'block';
                document.getElementById('controls').style.display = 'block';
                console.log('[3D Viewer] âœ“ Ready!');
            }, 1000);

            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', onWindowResize);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = clock.getDelta();

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ›´æ–°
            controls.update();

            // ãƒãƒƒãƒ—æ›´æ–°ï¼ˆè¡—ç¯ã®æ˜æ»…ãªã©ï¼‰
            if (shinjukuMap) {
                shinjukuMap.update(deltaTime);
            }

            // FPSè¨ˆæ¸¬
            fpsCounter++;
            fpsUpdateTime += deltaTime;
            if (fpsUpdateTime >= 1.0) {
                document.getElementById('fps').textContent = fpsCounter;
                fpsCounter = 0;
                fpsUpdateTime = 0;
            }

            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderer.render(scene, camera);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«åˆæœŸåŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
