<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒªãƒƒãƒ‰ãƒãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .game-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .game-container {
            border: 3px solid #0f3460;
            border-radius: 10px;
            background: #0a0a0a;
            box-shadow: 0 0 20px rgba(15, 52, 96, 0.5);
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            background: #1a1a2e;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            color: #00ffff;
            font-size: 14px;
            min-width: 250px;
        }

        .info-row {
            margin: 5px 0;
        }

        .controls-help {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 15px;
            font-size: 12px;
        }

        .controls-help h3 {
            color: #00ffff;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
        }

        .controls-help div {
            margin: 5px 0;
            color: #aaa;
        }

        .info-panel h3 {
            color: #00ffff;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="game-container">
            <canvas id="gameCanvas" width="800" height="576"></canvas>
        </div>

        <div class="side-panel">
            <div class="info-panel">
                <h3>ğŸ“ ãƒãƒƒãƒ—æƒ…å ±</h3>
                <div class="info-row">
                    <strong>ç¾åœ¨åœ°:</strong> <span id="mapName">æ–°å®¿ - éƒ½å¸‚ã‚¨ãƒªã‚¢</span>
                </div>
                <div class="info-row">
                    <strong>åº§æ¨™:</strong> (<span id="gridPos">25, 20</span>)
                </div>
                <div class="info-row">
                    <strong>æ­©æ•°:</strong> <span id="stepCount">0</span>
                </div>
                <div class="info-row">
                    <strong>å‘ã:</strong> <span id="facing">ä¸‹</span>
                </div>
            </div>

            <div class="controls-help">
                <h3>âŒ¨ï¸ æ“ä½œæ–¹æ³•</h3>
                <div>â†‘â†“â†â†’ : ç§»å‹•</div>
                <div>W A S D : ç§»å‹•</div>
                <div style="margin-top: 10px; color: #00ffff; font-size: 11px;">
                    âœ“ 1ãƒã‚¹ãšã¤ç§»å‹•<br>
                    âœ“ ç”»é¢ç«¯ã§ãƒãƒƒãƒ—åˆ‡æ›¿<br>
                    âœ“ å£ãƒ»éšœå®³ç‰©ã¯é€šè¡Œä¸å¯<br>
                    âœ“ è‰åœ°ã§ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="map-system-grid.js"></script>
    <script src="player-grid-movement.js"></script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        let gridMapSystem = null;
        let playerMovement = null;

        function initGame() {
            console.log('[INIT] Initializing Grid Map System...');

            // ã‚°ãƒªãƒƒãƒ‰ãƒãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            gridMapSystem = new GridMapSystem();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            playerMovement = new PlayerGridMovement(gridMapSystem);

            // åˆæœŸãƒãƒƒãƒ—ã®ã‚¹ãƒãƒ¼ãƒ³åœ°ç‚¹ã«é…ç½®
            const mapData = gridMapSystem.maps[gridMapSystem.currentMap];
            playerMovement.setPosition(mapData.spawnPoint.gridX, mapData.spawnPoint.gridY);

            // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            playerMovement.setOnStepCallback((stepCount) => {
                document.getElementById('stepCount').textContent = stepCount;
            });

            playerMovement.setOnExitCallback((exit) => {
                console.log('[EXIT] Detected:', exit);
                // ãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
                handleMapTransition(exit.targetMap, exit.direction);
            });

            playerMovement.setOnEncounterCallback(() => {
                console.log('[ENCOUNTER] Random encounter!');
                alert('æ•µãŒç¾ã‚ŒãŸï¼ï¼ˆæˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ã¯æœªå®Ÿè£…ï¼‰');
            });

            console.log('[INIT] Game initialized successfully');

            // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
            gameLoop();
        }

        // ãƒãƒƒãƒ—é·ç§»å‡¦ç†
        function handleMapTransition(targetMap, direction) {
            console.log(`[TRANSITION] Moving to ${targetMap} from ${direction}`);

            // ãƒãƒƒãƒ—å¤‰æ›´
            const spawn = gridMapSystem.changeMap(targetMap);

            if (spawn) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚’æ›´æ–°
                playerMovement.setPosition(spawn.gridX, spawn.gridY);

                // UIæ›´æ–°
                const mapData = gridMapSystem.maps[targetMap];
                document.getElementById('mapName').textContent = mapData.name;
            }
        }

        // ã‚­ãƒ¼å…¥åŠ›ç®¡ç†
        const keys = {};
        let lastProcessedKey = null;
        let lastKeyTime = 0;

        document.addEventListener('keydown', (e) => {
            // åŒã˜ã‚­ãƒ¼ã®é€£ç¶šå…¥åŠ›ã‚’é˜²ã
            const now = Date.now();
            if (e.key === lastProcessedKey && now - lastKeyTime < 150) {
                return;
            }

            if (!keys[e.key]) {
                keys[e.key] = true;

                // ç§»å‹•ã‚­ãƒ¼å‡¦ç†
                let moved = false;
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                    moved = playerMovement.tryMove('up');
                } else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                    moved = playerMovement.tryMove('down');
                } else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    moved = playerMovement.tryMove('left');
                } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    moved = playerMovement.tryMove('right');
                }

                if (moved) {
                    lastProcessedKey = e.key;
                    lastKeyTime = now;
                }
            }

            e.preventDefault();
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            // ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ãƒãƒƒãƒ—æç”»
            if (gridMapSystem) {
                gridMapSystem.render(ctx, canvas);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
            if (playerMovement) {
                playerMovement.update();
                playerMovement.render(ctx);

                // UIæ›´æ–°
                document.getElementById('gridPos').textContent =
                    `${playerMovement.gridX}, ${playerMovement.gridY}`;

                // å‘ãã‚’æ—¥æœ¬èªã«å¤‰æ›
                const facingMap = {
                    'up': 'ä¸Š',
                    'down': 'ä¸‹',
                    'left': 'å·¦',
                    'right': 'å³'
                };
                document.getElementById('facing').textContent = facingMap[playerMovement.facing] || playerMovement.facing;
            }

            // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ 
            requestAnimationFrame(gameLoop);
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(initGame, 100);
        });
    </script>
</body>
</html>
